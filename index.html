<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>TrendDS | Global Asset Ecosystem</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
    <style>
        /* --- ƏSAS DİZAYN SİSTEMİ (TOXUNULMAZ) --- */
        :root {
            --primary: #0d47a1; --secondary: #1565c0; --success: #00c853; --danger: #d32f2f;
            --bg: #f3f4f6; --card-bg: #ffffff; --text: #1e293b; --gold: #FFD700;
            --glass: rgba(255, 255, 255, 0.7); --glass-border: rgba(255, 255, 255, 0.2);
        }
        [data-theme="dark"] { --bg: #0f172a; --card-bg: #1e293b; --text: #f8fafc; --glass: rgba(30, 41, 59, 0.7); }
        
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg); color: var(--text); padding-bottom: 100px; overflow-x: hidden; transition: 0.3s; }

        /* --- UI ELEMENTLƏRİ --- */
        .glass-panel { background: var(--glass); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid var(--glass-border); border-radius: 16px; }
        .skeleton { background: linear-gradient(90deg, #eee 25%, #f5f5f5 50%, #eee 75%); background-size: 200% 100%; animation: loading 1.5s infinite; border-radius: 4px; }
        @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        
        #cinematicLoader { position: fixed; inset: 0; background: #000; z-index: 99999; display: flex; align-items: center; justify-content: center; flex-direction: column; animation: fadeOutLoader 1s ease 2.5s forwards; }
        .brand-anim { font-size: 40px; font-weight: 900; color: white; letter-spacing: 5px; animation: textExpand 2s ease-out; }
        @keyframes fadeOutLoader { to { opacity: 0; visibility: hidden; } }

        #scrollProgress { position: fixed; top: 0; left: 0; height: 3px; background: var(--gold); z-index: 10000; width: 0%; transition: 0.1s; }

        #particles { position: absolute; inset: 0; z-index: 0; opacity: 0.3; pointer-events: none; }
        .ticker-wrap { position: fixed; top: 0; left: 0; width: 100%; overflow: hidden; height: 30px; background-color: #000; z-index: 9000; display: flex; align-items: center; border-bottom: 1px solid #333; }
        .ticker { display: inline-block; white-space: nowrap; padding-left: 100%; animation: ticker 40s linear infinite; }
        .ticker-item { display: inline-block; padding: 0 15px; font-size: 11px; color: #ccc; font-weight: 600; }
        .up { color: var(--success); } .down { color: var(--danger); }
        @keyframes ticker { 0% { transform: translate3d(0, 0, 0); } 100% { transform: translate3d(-100%, 0, 0); } }
        
        .hero { background: linear-gradient(135deg, #0d47a1, #000000); color: white; padding: 80px 20px 70px 20px; border-bottom-left-radius: 30px; border-bottom-right-radius: 30px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.4); position: relative; overflow: hidden; }
        
        .globe-container { width: 100px; height: 100px; margin: 0 auto 10px; position: relative; perspective: 1000px; }
        .globe { width: 100%; height: 100%; border-radius: 50%; background: url('https://upload.wikimedia.org/wikipedia/commons/thumb/2/23/Blue_Marble_2002.png/1024px-Blue_Marble_2002.png'); background-size: 200px; animation: spinGlobe 10s linear infinite; box-shadow: inset 0 0 20px rgba(0,0,0,0.5); }
        @keyframes spinGlobe { from { background-position: 0 0; } to { background-position: 200px 0; } }

        .chart-container { margin: -40px 20px 20px 20px; background: var(--card-bg); border-radius: 16px; padding: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); position: relative; z-index: 10; }
        canvas { width: 100%; height: 100px; }
        
        /* MOBİL UYĞUNLUQ ÜÇÜN DÜZƏLİŞLƏR */
        .market-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; padding: 0 20px 20px 20px; position: relative; z-index: 20; }
        @media (max-width: 350px) { .market-grid { grid-template-columns: 1fr; } }

        .item-card { background: var(--card-bg); border-radius: 16px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.05); transition: 0.2s; position: relative; display: flex; flex-direction: column; }
        .item-img { width: 100%; height: 100px; object-fit: cover; }
        .item-body { padding: 12px; flex: 1; display: flex; flex-direction: column; justify-content: space-between; }
        
        .social-toast { position: fixed; bottom: 80px; left: 20px; background: rgba(0,0,0,0.8); color: white; padding: 10px 15px; border-radius: 50px; font-size: 11px; display: flex; align-items: center; gap: 10px; z-index: 8000; opacity: 0; transform: translateY(20px); transition: 0.5s; pointer-events: none; }
        .social-toast.show { opacity: 1; transform: translateY(0); }
        .st-img { width: 25px; height: 25px; border-radius: 50%; background: var(--success); }
        
        .ai-widget { position: fixed; bottom: 100px; right: 20px; width: 50px; height: 50px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; box-shadow: 0 5px 20px rgba(13, 71, 161, 0.5); cursor: pointer; z-index: 6000; animation: bounce 2s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        
        .btn-main { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 14px; touch-action: manipulation; position: relative; z-index: 30; }
        .btn-main:active { transform: scale(0.96); opacity: 0.9; }
        
        .inp-field { width: 100%; padding: 15px; border: 1px solid #ddd; border-radius: 12px; margin-bottom: 10px; font-size: 16px; } 
        
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 25000; display: none; align-items: center; justify-content: center; padding: 20px; }
        .modal-card { background: var(--card-bg); width: 100%; max-width: 350px; padding: 25px; border-radius: 20px; text-align: center; box-shadow: 0 0 50px rgba(0,0,0,0.5); animation: zoomIn 0.3s; }
        @keyframes zoomIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .visa-card { background: linear-gradient(135deg, #1a1a1a, #333); color: white; border-radius: 15px; padding: 20px; margin: 0 20px 20px 20px; position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.3); border: 1px solid #444; overflow: hidden; transition: 0.5s; }
        .visa-chip { width: 40px; height: 30px; background: linear-gradient(135deg, #FFD700, #B8860B); border-radius: 5px; margin-bottom: 20px; }
        
        .cookie-banner { position: fixed; bottom: 0; left: 0; width: 100%; background: #222; color: white; padding: 15px; z-index: 20000; display: flex; justify-content: space-between; align-items: center; font-size: 11px; transform: translateY(100%); transition: 0.5s; padding-bottom: 30px; }
        .cookie-banner.show { transform: translateY(0); }

        .fg-meter { height: 10px; background: linear-gradient(90deg, red, yellow, green); border-radius: 5px; margin: 10px 0; position: relative; }
        .fg-pointer { width: 2px; height: 14px; background: white; position: absolute; top: -2px; left: 60%; transition: 1s; }

        .hot-tag { position: absolute; top: 10px; right: 10px; background: red; color: white; font-size: 9px; padding: 3px 8px; border-radius: 10px; animation: pulse 1s infinite; z-index: 2; }
        .risk-tag { font-size: 9px; padding: 2px 6px; border-radius: 4px; border: 1px solid #ccc; color: #666; margin-left: 5px; }

        #authScreen { position: fixed; inset: 0; z-index: 10000; background: linear-gradient(135deg, #000, #0d47a1); display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .auth-card { background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); padding: 40px 30px; border-radius: 20px; width: 100%; max-width: 380px; text-align: center; color: white; border: 1px solid rgba(255,255,255,0.2); position: relative; z-index: 2; }
        
        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: var(--card-bg); height: 80px; display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #eee; z-index: 5000; padding-bottom: 20px; }
        .nav-btn { flex: 1; text-align: center; color: #888; background: none; border: none; font-size: 10px; padding: 5px; }
        .nav-btn.active { color: var(--primary); }
        .nav-btn i { font-size: 24px; display: block; margin-bottom: 5px; }
        
        .chat-box { position: fixed; bottom: 90px; right: 20px; width: 300px; background: white; border-radius: 15px; box-shadow: 0 5px 30px rgba(0,0,0,0.2); z-index: 6000; display: none; padding: 15px; }
        .chat-header { font-weight: bold; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; }

        .confetti { position: fixed; width: 10px; height: 10px; background-color: #f00; animation: fall linear forwards; z-index: 24000; }
        @keyframes fall { to { transform: translateY(100vh) rotate(720deg); } }

    </style>
</head>
<body>

    <div id="cinematicLoader">
        <div class="brand-anim">TRENDDS</div>
        <div style="font-size:12px; color:gold; margin-top:10px;">ULTIMATE EDITION</div>
    </div>

    <div id="scrollTop" onclick="window.scrollTo(0,0)" style="position:fixed; bottom:160px; right:20px; background:#333; color:white; width:35px; height:35px; border-radius:50%; display:none; align-items:center; justify-content:center; z-index:4000; cursor:pointer;"><i class="fas fa-arrow-up"></i></div>

    <div id="cookieBanner" class="cookie-banner">
        <div>We use cookies for secure asset management. <a href="#" style="color:var(--gold)">Policy</a></div>
        <button onclick="document.getElementById('cookieBanner').classList.remove('show')" style="background:var(--success); border:none; color:white; padding:5px 15px; border-radius:5px;">Accept</button>
    </div>

    <audio id="sndDing" src="https://assets.mixkit.co/sfx/preview/mixkit-positive-interface-beep-221.mp3"></audio>

    <div id="scrollProgress"></div>

    <div class="ticker-wrap">
        <div class="ticker">
            <span class="ticker-item">BTC <span class="up">$98,420 ▲</span></span>
            <span class="ticker-item">ETH <span class="up">$3,210 ▲</span></span>
            <span class="ticker-item">XRP <span class="down">$0.55 ▼</span></span>
            <span class="ticker-item"><i class="fas fa-fire" style="color:orange"></i> HOT: Real Estate +15%</span>
            <span class="ticker-item">USER_88 invested <span class="up">$5,000</span></span>
        </div>
    </div>

    <div id="authScreen">
        <canvas id="particles"></canvas>
        <div class="auth-card animate__animated animate__fadeInUp">
            <i class="fas fa-fingerprint" style="font-size:50px; margin-bottom:20px; color:var(--gold); opacity:0.8; animation: pulse 2s infinite;"></i>
            <h2 style="margin-bottom:5px;">TrendDS Global</h2>
            <p style="font-size:12px; opacity:0.7; margin-bottom:30px;">Secure Biometric Access</p>
            <input type="text" id="rName" class="inp-field" placeholder="Full Name" style="background:rgba(255,255,255,0.9); color:#333;">
            <input type="email" id="rEmail" class="inp-field" placeholder="Email" style="background:rgba(255,255,255,0.9); color:#333;">
            <button class="btn-main" onclick="startBiometricLogin()"><i class="fas fa-face-viewfinder"></i> FACE ID LOGIN</button>
        </div>
    </div>

    <div id="appScreen" style="display:none; padding-top:30px;">
        
        <div id="socialToast" class="social-toast">
            <div class="st-img"></div>
            <div id="stText">User invested $500</div>
        </div>

        <div class="ai-widget" onclick="toggleChat()">
            <i class="fas fa-comments"></i>
        </div>
        <div id="chatBox" class="chat-box">
            <div class="chat-header"><span>AI Support</span> <span onclick="toggleChat()" style="cursor:pointer">x</span></div>
            <div style="height:150px; overflow-y:auto; font-size:12px; color:#666;" id="chatContent">
                <div>Bot: Hello! How can I help with your investment?</div>
            </div>
            <input type="text" placeholder="Type..." style="width:100%; border:1px solid #ddd; padding:5px; margin-top:10px;" onkeypress="if(event.key==='Enter') sendChat(this)">
        </div>

        <div id="p2pModal" class="modal-overlay">
            <div class="modal-card">
                <h3><i class="fas fa-exchange-alt"></i> P2P Transfer</h3>
                <input type="text" class="inp-field" placeholder="Receiver ID (e.g. U-992)" style="margin-top:10px;">
                <input type="number" class="inp-field" placeholder="Amount ($)">
                <button class="btn-main" onclick="alert('Sent successfully!'); closeModal('p2pModal')">Send Funds</button>
                <button class="btn-main" style="background:#ccc; color:#333; margin-top:5px;" onclick="closeModal('p2pModal')">Cancel</button>
            </div>
        </div>

        <div id="swapModal" class="modal-overlay">
            <div class="modal-card">
                <h3><i class="fas fa-sync"></i> Swap Assets</h3>
                <div style="display:flex; justify-content:space-between; margin:15px 0;">
                    <div style="padding:10px; border:1px solid #ddd; border-radius:8px;">USD</div>
                    <i class="fas fa-arrow-right" style="margin-top:10px;"></i>
                    <div style="padding:10px; border:1px solid #ddd; border-radius:8px;">BTC</div>
                </div>
                <input type="number" class="inp-field" placeholder="Amount to Swap">
                <button class="btn-main" onclick="alert('Swapped to BTC Wallet'); closeModal('swapModal')">Execute Swap</button>
                <button class="btn-main" style="background:#ccc; color:#333; margin-top:5px;" onclick="closeModal('swapModal')">Cancel</button>
            </div>
        </div>

        <div id="successModal" class="modal-overlay">
            <div class="modal-card">
                <div class="modal-icon" style="color:var(--success); font-size:50px;"><i class="fas fa-check-circle"></i></div>
                <div class="modal-title" style="font-weight:800; font-size:20px; margin-top:10px;">Təbrik edirik!</div>
                <div class="modal-text" id="successMsg" style="margin:15px 0;"></div>
                <button class="btn-main" style="background:var(--success)" onclick="closeModal('successModal')">Əla!</button>
            </div>
        </div>

        <div id="view-home" style="display:block;">
            <div class="hero">
                <div style="font-size:10px; background:rgba(255,255,255,0.2); display:inline-block; padding:2px 8px; border-radius:10px; margin-bottom:5px;">
                    <i class="fas fa-bullhorn"></i> Maintenance completed.
                </div>

                <div style="position:absolute; top:40px; right:20px; z-index:500; display:flex; gap:5px;">
                    <button class="nav-btn" style="color:white; border:1px solid rgba(255,255,255,0.3); padding:2px 8px; border-radius:10px;" onclick="toggleTheme()">DARK</button>
                    <button class="nav-btn" style="color:white; position:relative;"><i class="fas fa-bell"></i><span style="position:absolute; top:0; right:0; width:8px; height:8px; background:red; border-radius:50%;"></span></button>
                </div>

                <div class="globe-container"><div class="globe"></div></div>
                <h1 id="heroTitle">TrendDS Global</h1>
                <p>AI-Powered Asset Management Ecosystem</p>
                
                <div style="width:200px; margin:10px auto; text-align:left;">
                    <div style="font-size:10px; display:flex; justify-content:space-between;"><span>Fear</span><span>Greed</span></div>
                    <div class="fg-meter"><div class="fg-pointer"></div></div>
                    <div style="font-size:10px; text-align:center;">Market Sentiment: <b>GREED (60)</b></div>
                </div>
            </div>

            <div class="chart-container">
                <div style="display:flex; justify-content:space-between; font-size:12px; margin-bottom:5px;">
                    <span>TDS INDEX</span><span style="color:green">+12.4%</span>
                </div>
                <canvas id="liveChart"></canvas>
            </div>

            <h4 style="padding:0 20px; margin-bottom:10px;">Investment Packages</h4>
            <div class="market-grid" id="marketGrid"></div>
            
            <div style="padding:20px; font-size:11px; color:#666; text-align:center;">
                <i class="fas fa-cloud"></i> 28. Financial Weather: <span style="color:green">Sunny (Bull Market)</span>
            </div>
            <div style="height:100px;"></div>
        </div>

        <div id="view-cabinet" style="display:none;">
            <div style="text-align:right; padding:0 20px; font-size:10px; color:#666; cursor:pointer;" onclick="changeCardColor()">
                <i class="fas fa-palette"></i> Change Skin
            </div>
            
            <div class="visa-card" id="myVisa">
                <div style="position:absolute; top:20px; right:20px; font-weight:bold; font-style:italic; font-size:20px;">VISA</div>
                <div class="visa-chip"></div>
                <div style="font-family:monospace; font-size:18px; letter-spacing:2px; margin-bottom:15px; text-shadow:0 2px 2px rgba(0,0,0,0.5);">
                    4455 •••• •••• 9012
                </div>
                <div style="display:flex; justify-content:space-between;">
                    <div style="text-transform:uppercase; font-size:12px; opacity:0.8;" id="cardName">USER NAME</div>
                    <div style="font-size:12px;">EXP 12/28</div>
                </div>
            </div>

            <div class="profile-header" style="border:none; padding-top:0; text-align:center;">
                <h3 id="dispName">User</h3>
                <div style="font-size:30px; font-weight:800; margin-top:5px; cursor:pointer;" id="dispBalance" onclick="togglePrivacy()">$0.00</div>
                <div style="font-size:12px; color:var(--success);">Lifetime Profit: <span id="dispEarned">$0.00</span></div>
                
                <div style="font-size:9px; color:#999; margin-top:5px;">Last Login: IP 192.168.1.12 • Baku</div>
                
                <div style="margin-top:5px; font-size:10px; font-weight:bold; color:#555;">XP Level 5 <div style="width:100px; height:4px; background:#eee; display:inline-block; vertical-align:middle; margin-left:5px; border-radius:2px;"><div style="width:60%; height:100%; background:var(--primary); border-radius:2px;"></div></div></div>
            </div>
            
            <div class="glass-panel" style="margin:0 20px; padding:20px;">
                 <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:15px;">
                     <button class="btn-main" onclick="requestDeposit()" style="background:#25D366;"><i class="fab fa-whatsapp"></i> Deposit</button>
                     <button class="btn-main" onclick="handleWithdraw()" style="background:var(--text);"><i class="fas fa-wallet"></i> Withdraw</button>
                     <button class="btn-main" onclick="openModal('p2pModal')" style="background:#ff9800;"><i class="fas fa-paper-plane"></i> P2P</button>
                     <button class="btn-main" onclick="openModal('swapModal')" style="background:#9c27b0;"><i class="fas fa-sync"></i> Swap</button>
                 </div>
                 
                 <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; font-size:12px;">
                     <span><i class="fas fa-shield-alt"></i> 2FA Security</span>
                     <label style="position:relative; display:inline-block; width:34px; height:20px;">
                         <input type="checkbox" checked><span style="position:absolute; cursor:pointer; top:0; left:0; right:0; bottom:0; background-color:#2196F3; transition:.4s; border-radius:34px;"></span>
                     </label>
                 </div>

                 <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; font-size:12px;">
                     <span><i class="fas fa-recycle"></i> Auto-Reinvest</span>
                     <label style="position:relative; display:inline-block; width:34px; height:20px;">
                         <input type="checkbox"><span style="position:absolute; cursor:pointer; top:0; left:0; right:0; bottom:0; background-color:#ccc; transition:.4s; border-radius:34px;"></span>
                     </label>
                 </div>

                 <div style="margin-top:20px;">
                    <input type="text" id="pCode" class="inp-field" placeholder="Enter Promo Code">
                    <button class="btn-main" onclick="applyPromo()">Activate Code</button>
                 </div>

                 <div style="margin-top:20px; position:relative;">
                     <input type="text" placeholder="Search transactions..." style="width:100%; padding:8px; border:1px solid #eee; border-radius:8px; font-size:12px;">
                     <i class="fas fa-search" style="position:absolute; right:10px; top:10px; color:#ccc;"></i>
                 </div>

                 <h4 style="margin-top:20px;">Active Portfolio</h4>
                 <div id="portfolioList">
                     <div class="skeleton" style="height:50px; margin-bottom:10px;"></div>
                     <div class="skeleton" style="height:50px; margin-bottom:10px;"></div>
                 </div>
                 
                 <button class="btn-main" onclick="logout()" style="background:#444; margin-top:20px;">Log Out</button>
            </div>
            <div style="height:100px;"></div>
        </div>

        <div class="bottom-nav">
            <button class="nav-btn active" onclick="switchView('home', this)"><i class="fas fa-globe"></i> Hub</button>
            <button class="nav-btn" onclick="switchView('cabinet', this)"><i class="fas fa-wallet"></i> Wallet</button>
            <button class="nav-btn" onclick="document.getElementById('calcModal').style.display='flex'"><i class="fas fa-calculator"></i> Calc</button>
            <button class="nav-btn" onclick="contactSupport()"><i class="fas fa-headset"></i> Help</button>
        </div>
        
        <div style="position:fixed; bottom:85px; left:0; width:100%; text-align:center; font-size:9px; color:#999; z-index:4000; pointer-events:none;">
            <span style="width:8px;height:8px;background:#00c853;border-radius:50%;display:inline-block;"></span> Systems Operational | Encrypted
        </div>

    </div>

    <script>
        const STORAGE_KEY = 'trendds_forever_session_v4'; // Key for permanent login

        // --- PRELOADER & AUTO LOGIN ---
        window.onload = () => { 
            setTimeout(() => { document.getElementById('cookieBanner').classList.add('show'); }, 3000); 
            
            // FOREVER LOGIN CHECK
            const savedData = localStorage.getItem(STORAGE_KEY);
            if(savedData) {
                user = JSON.parse(savedData);
                initApp(); // Skip login if data exists
            }
        };

        window.onscroll = () => {
            let winScroll = document.body.scrollTop || document.documentElement.scrollTop;
            let height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
            let scrolled = (winScroll / height) * 100;
            document.getElementById("scrollProgress").style.width = scrolled + "%";
            document.getElementById("scrollTop").style.display = winScroll > 100 ? 'flex' : 'none';
        };

        // --- 1. PARTICLES ---
        const canvas = document.getElementById("particles"); const ctx = canvas.getContext("2d"); canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        let particlesArray = []; class Particle { constructor(){ this.x=Math.random()*canvas.width; this.y=Math.random()*canvas.height; this.size=Math.random()*2; this.speedX=Math.random()*1-0.5; this.speedY=Math.random()*1-0.5; } update(){ this.x+=this.speedX; this.y+=this.speedY; if(this.size>0.2) this.size-=0.1; } draw(){ ctx.fillStyle='rgba(255,255,255,0.5)'; ctx.beginPath(); ctx.arc(this.x,this.y,this.size,0,Math.PI*2); ctx.fill(); } }
        setInterval(()=>{ particlesArray.push(new Particle()); }, 100); function animate(){ ctx.clearRect(0,0,canvas.width,canvas.height); for(let i=0; i<particlesArray.length; i++){ particlesArray[i].update(); particlesArray[i].draw(); if(particlesArray[i].size<=0.3){particlesArray.splice(i,1);i--;}} requestAnimationFrame(animate); } animate();

        // --- CHART ---
        const chartC = document.getElementById('liveChart'); const cCtx = chartC.getContext('2d'); let cData = [50, 52, 51, 53, 55, 54, 58, 60, 59, 62, 65, 63, 67, 70];
        function drawChart() { chartC.width = chartC.offsetWidth; chartC.height = chartC.offsetHeight; cCtx.clearRect(0,0,chartC.width,chartC.height); cCtx.beginPath(); cCtx.moveTo(0, chartC.height); let step = chartC.width / (cData.length - 1); for(let i=0; i<cData.length; i++){ let h = 100 - cData[i]; cCtx.lineTo(i*step, h); } cCtx.strokeStyle = '#00c853'; cCtx.lineWidth = 2; cCtx.stroke(); if(Math.random()>0.5) cData.push(cData[cData.length-1] + Math.random()*2); else cData.push(cData[cData.length-1] - Math.random()*2); if(cData.length > 20) cData.shift(); }
        setInterval(drawChart, 1000);

        // --- CORE LOGIC ---
        const API = "https://script.google.com/macros/s/AKfycbw6gXUMslAGxWx21nUKzDhND279Yjv-VckDo8Y_fMEg-m7J35ocE8weS-mVeXLDzdR3/exec";
        const PHONE = "994507516137";
        let user = { name:"", email:"", balance:0, earned:0, investments:[], lastWithdraw:0 };
        let privacy = false;
        
        const markets = [
            {n:"Real Estate", p:500, img:"https://images.unsplash.com/photo-1560518883-ce09059eeffa", risk:"Low", hot:true}, 
            {n:"Stocks", p:400, img:"https://images.unsplash.com/photo-1611974765270-ca1258634369", risk:"Medium", hot:false},
            {n:"Tech AI", p:300, img:"https://images.unsplash.com/photo-1518770660439-4636190af475", risk:"High", hot:true},
            {n:"Agro", p:200, img:"https://images.unsplash.com/photo-1625246333195-78d9c38ad449", risk:"Low", hot:false},
            {n:"Retail", p:100, img:"https://images.unsplash.com/photo-1542838132-92c53300491e", risk:"Medium", hot:false},
            {n:"Goods", p:50, img:"https://images.unsplash.com/photo-1583947215259-38e31be8751f", risk:"Low", hot:false}
        ];

        // 7. SOUND FX
        function playSound() { document.getElementById('sndDing').play().catch(e=>{}); }
        function vibe() { if(navigator.vibrate) navigator.vibrate(50); }

        // 20. CHAT
        function toggleChat() { let b = document.getElementById('chatBox'); b.style.display = b.style.display==='block'?'none':'block'; }
        function sendChat(e) { 
            document.getElementById('chatContent').innerHTML += `<div style="text-align:right;margin-top:5px;color:blue;">${e.value}</div>`; 
            e.value=''; 
            setTimeout(()=>{ document.getElementById('chatContent').innerHTML += `<div style="margin-top:5px;">Bot: Connecting to agent...</div>`; playSound(); }, 1000);
        }

        function closeModal(id) { document.getElementById(id).style.display='none'; }
        function openModal(id) { document.getElementById(id).style.display='flex'; }
        
        // 23. CARD COLOR
        function changeCardColor() {
            const colors = ['linear-gradient(135deg, #1a1a1a, #333)', 'linear-gradient(135deg, #0d47a1, #000)', 'linear-gradient(135deg, #b71c1c, #000)'];
            document.getElementById('myVisa').style.background = colors[Math.floor(Math.random()*colors.length)];
        }

        // 6. PRIVACY MODE
        function togglePrivacy() {
            privacy = !privacy;
            document.getElementById('dispBalance').innerText = privacy ? "$****" : "$"+user.balance.toFixed(2);
        }

        // 4. CALCULATOR
        function calcProfit() {
            let val = document.getElementById('calcInput').value;
            document.getElementById('calcDaily').innerText = "$" + (val * 0.015).toFixed(2);
            document.getElementById('calcMonthly').innerText = "$" + (val * 0.015 * 30).toFixed(2);
        }

        // 2. BIOMETRIC LOGIN
        function startBiometricLogin() {
            const btn = document.querySelector('.auth-card button');
            btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> SCANNING...`;
            setTimeout(() => { handleLogin(); }, 1500);
        }

        async function handleLogin() {
            const n = document.getElementById('rName').value, e = document.getElementById('rEmail').value;
            if(!n || !e) return alert("Fill fields");
            try {
                const res = await fetch(`${API}?action=login&name=${n}&email=${e}`);
                const data = await res.json();
                user.name=n; user.email=e; user.balance=parseFloat(data.data.balance||0); user.earned=parseFloat(data.data.earned||0);
                
                // Attempt to merge with local data if it exists
                const saved = localStorage.getItem(STORAGE_KEY);
                if(saved) { 
                    const p = JSON.parse(saved); 
                    if(p.email === e) { // Only merge if same email
                        user.investments = p.investments || []; 
                        user.lastWithdraw = p.lastWithdraw || 0;
                        user.earned = Math.max(user.earned, p.earned || 0); // Keep local earned if higher
                    }
                }
                
                saveData(); // Save immediately for persistence
                initApp();
            } catch(e){ alert("Connection Error"); initApp(); }
        }

        function initApp() {
            document.getElementById('authScreen').style.display='none';
            document.getElementById('appScreen').style.display='block';
            document.getElementById('dispName').innerText = user.name;
            document.getElementById('cardName').innerText = user.name;
            renderGrid(); updateUI();
            
            // RUN CALCULATOR EVERY SECOND
            setInterval(calcRewards, 1000);
        }

        function logout() {
            if(confirm("Exit secure session?")) {
                localStorage.removeItem(STORAGE_KEY);
                location.reload();
            }
        }

        function renderGrid() {
            const g = document.getElementById('marketGrid'); g.innerHTML="";
            markets.forEach(m=>{
                let hotHtml = m.hot ? `<span class="hot-tag">HOT</span>` : '';
                let riskColor = m.risk === 'High' ? 'red' : (m.risk === 'Medium' ? 'orange' : 'green');
                g.innerHTML+=`<div class="item-card">
                    ${hotHtml}
                    <img src="${m.img}?auto=format&fit=crop&q=80" class="item-img">
                    <div class="item-body">
                        <div style="font-weight:700;">${m.n} <span class="risk-tag" style="border-color:${riskColor};color:${riskColor}">${m.risk}</span></div>
                        <div class="item-price">$${m.p}</div>
                        <button class="btn-main" style="margin-top:5px;padding:8px;font-size:12px;" ontouchstart="invest('${m.n}',${m.p})" onclick="invest('${m.n}',${m.p})">INVEST</button>
                    </div>
                </div>`;
            });
        }

        // --- SECOND BY SECOND PROFIT CALCULATION ---
        function calcRewards() {
            if(user.investments.length>0) {
                user.investments.forEach(i => {
                    // Daily 1.5% -> per second
                    const perSecond = (i.amount * 0.015) / 86400; 
                    user.earned += perSecond;
                });
                updateUI(); saveData();
            }
        }

        // --- FIXED INVEST LOGIC ---
        function invest(n,p) {
            vibe();
            if(user.balance<p) { 
                if(confirm("Insufficient Balance. Deposit?")) switchView('cabinet'); 
                return; 
            }
            user.balance-=p; 
            user.investments.push({name:n, amount:p, time:Date.now()});
            
            document.getElementById('successMsg').innerHTML = `Siz <b>${n}</b> paketinə <b>$${p}</b> investisiya etdiniz.<br>Gündəlik qazanc: 1.5%`;
            openModal('successModal');
            fireConfetti();
            
            playSound(); updateUI(); saveData(); sync(`Invest ${n}`);
        }

        function fireConfetti() {
            for(let i=0; i<30; i++) {
                const c = document.createElement('div');
                c.className = 'confetti';
                c.style.left = Math.random()*100 + 'vw';
                c.style.backgroundColor = ['#f00','#0f0','#00f','#ff0'][Math.floor(Math.random()*4)];
                c.style.animationDuration = (Math.random()*2+2)+'s';
                document.body.appendChild(c);
                setTimeout(()=>c.remove(), 4000);
            }
        }

        // --- PRINCIPAL WITHDRAW LOGIC ---
        function withdrawPrincipal(index) {
            vibe();
            let inv = user.investments[index];
            if(confirm(`Withdraw principal amount ($${inv.amount})? This will stop daily profits.`)) {
                user.investments.splice(index, 1);
                saveData(); updateUI();
                sync(`Principal Withdraw ${inv.amount}`);
                window.location.href=`https://api.whatsapp.com/send?phone=${PHONE}&text=Requesting Principal Withdrawal: $${inv.amount} for ${user.email}`;
            }
        }

        function updateUI() {
            if(!privacy) document.getElementById('dispBalance').innerText="$"+user.balance.toFixed(2);
            // 6 DECIMAL PLACES FOR LIVE EFFECT
            document.getElementById('dispEarned').innerText="$"+user.earned.toFixed(6);
            
            let html="";
            user.investments.forEach((i, index)=>{
                let days = Math.floor((Date.now()-i.time)/(86400000));
                let isLocked = days < 30;
                let btnHtml = isLocked ? `<span style="color:red;font-size:10px;"><i class="fas fa-lock"></i> Locked (${30-days}d)</span>` : `<button onclick="withdrawPrincipal(${index})" style="background:var(--dark);color:white;border:none;border-radius:4px;padding:2px 5px;font-size:10px;cursor:pointer;">Withdraw Principal</button>`;
                
                html+=`<div style="background:#f8f9fa;padding:10px;margin-bottom:5px;border-radius:8px;font-size:12px;display:flex;justify-content:space-between;align-items:center;">
                    <div><b>${i.name}</b><br><span style="color:#666">$${i.amount}</span></div>
                    <div>${btnHtml}</div>
                </div>`;
            });
            document.getElementById('portfolioList').innerHTML=html || "No assets.";
        }

        function toggleTheme() { if(document.body.getAttribute('data-theme')==='dark') document.body.removeAttribute('data-theme'); else document.body.setAttribute('data-theme','dark'); }
        
        // --- FIXED WHATSAPP & LOGIC ---
        function requestDeposit() { 
            let a = prompt("Deposit Amount ($):"); 
            if(a) window.location.href=`https://api.whatsapp.com/send?phone=${PHONE}&text=Deposit request $${a} for ${user.email}`; 
        }
        
        function handleWithdraw() { 
            if(user.earned<20) return alert("Minimum withdrawal is $20"); 
            if(user.lastWithdraw && (Date.now() - user.lastWithdraw) < 259200000) return alert("Profit withdrawal allowed every 3 days.");
            
            let a = prompt("Profit Withdrawal Amount ($):"); 
            if(a) {
                let amount = parseFloat(a);
                if(isNaN(amount) || amount > user.earned) return alert("Insufficient profit balance or invalid amount.");
                
                user.earned -= amount; // Deduct immediately
                user.lastWithdraw = Date.now();
                updateUI(); saveData(); sync(`Withdraw Profit $${amount}`); 
                window.location.href=`https://api.whatsapp.com/send?phone=${PHONE}&text=Profit Withdraw request $${amount} for ${user.email}`; 
            } 
        }
        
        async function applyPromo() { let c = document.getElementById('pCode').value; if(!c) return; try { let r = await fetch(`${API}?action=applyCode&code=${c}&email=${user.email}`); let d = await r.json(); if(d.result==='success') { user.balance+=d.amount; updateUI(); saveData(); sync("Code applied"); alert("Success!"); playSound(); } else alert("Invalid Code"); } catch(e){} }
        
        // PERSISTENT STORAGE
        function saveData() { localStorage.setItem(STORAGE_KEY, JSON.stringify(user)); }
        
        function sync(s) { fetch(`${API}?action=sync&email=${user.email}&balance=${user.balance.toFixed(2)}&earned=${user.earned.toFixed(2)}&lastStatus=${s}`, {mode:'no-cors'}); }
        function switchView(v,b) { document.getElementById('view-home').style.display = v==='home'?'block':'none'; document.getElementById('view-cabinet').style.display = v==='cabinet'?'block':'none'; document.querySelectorAll('.nav-btn').forEach(x=>x.classList.remove('active')); if(b) b.classList.add('active'); }
        function contactSupport() { window.location.href=`https://api.whatsapp.com/send?phone=${PHONE}&text=Support needed`; }
    </script>
</body>
</html>
